<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Values and pointers: What could possibly go wrong? | adonese&#39;s Blog</title>
<meta name="keywords" content="" />
<meta name="description" content="This post highlights a weird and expected behavior we encountered while using Go&rsquo;s encoding/json library.
In go, we pass by value, that really means this:
type User struct { Name string } func changeMe(u User) { u.Name = &#34;New Name&#34; } func main(){ u := User{Name: &#34;mohamed&#34;} changeMe(u) log.Printf(&#34;The user is: %s&#34;, u.Name) // mohamed } To change by value, we must pass a pointer, we can change the code to be something like this:">
<meta name="author" content="">
<link rel="canonical" href="/post/2020-10-30-values-types-and-pointers/" />


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.6f60056d44d3f7eb69a4bc6c332b59960f3a995802bded244750232f33713c49.css" integrity="sha256-b2AFbUTT9&#43;tppLxsMytZlg86mVgCve0kR1AjLzNxPEk=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="mask-icon" href="safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.88.1" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Values and pointers: What could possibly go wrong?" />
<meta property="og:description" content="This post highlights a weird and expected behavior we encountered while using Go&rsquo;s encoding/json library.
In go, we pass by value, that really means this:
type User struct { Name string } func changeMe(u User) { u.Name = &#34;New Name&#34; } func main(){ u := User{Name: &#34;mohamed&#34;} changeMe(u) log.Printf(&#34;The user is: %s&#34;, u.Name) // mohamed } To change by value, we must pass a pointer, we can change the code to be something like this:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/2020-10-30-values-types-and-pointers/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-10-30T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-10-30T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Values and pointers: What could possibly go wrong?"/>
<meta name="twitter:description" content="This post highlights a weird and expected behavior we encountered while using Go&rsquo;s encoding/json library.
In go, we pass by value, that really means this:
type User struct { Name string } func changeMe(u User) { u.Name = &#34;New Name&#34; } func main(){ u := User{Name: &#34;mohamed&#34;} changeMe(u) log.Printf(&#34;The user is: %s&#34;, u.Name) // mohamed } To change by value, we must pass a pointer, we can change the code to be something like this:"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Values and pointers: What could possibly go wrong?",
      "item": "/post/2020-10-30-values-types-and-pointers/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Values and pointers: What could possibly go wrong?",
  "name": "Values and pointers: What could possibly go wrong?",
  "description": "This post highlights a weird and expected behavior we encountered while using Go\u0026rsquo;s encoding/json library.\nIn go, we pass by value, that really means this:\ntype User struct { Name string } func changeMe(u User) { u.Name = \u0026#34;New Name\u0026#34; } func main(){ u := User{Name: \u0026#34;mohamed\u0026#34;} changeMe(u) log.Printf(\u0026#34;The user is: %s\u0026#34;, u.Name) // mohamed } To change by value, we must pass a pointer, we can change the code to be something like this:",
  "keywords": [
    
  ],
  "articleBody": "This post highlights a weird and expected behavior we encountered while using Go’s encoding/json library.\nIn go, we pass by value, that really means this:\ntype User struct { Name string } func changeMe(u User) { u.Name = \"New Name\" } func main(){ u := User{Name: \"mohamed\"} changeMe(u) log.Printf(\"The user is: %s\", u.Name) // mohamed } To change by value, we must pass a pointer, we can change the code to be something like this:\nfunc changeMe(u *User) { u.Name = \"New Name\" } // same code  u := User{Name: \"mohamed\"} changeMe(\u0026u) // log.Printf(\"The user is: %s\", u.Name) // New Name But in go, we slightly use a different syntax for this, we use a method receiver on the struct. More like method to classes on other languages.\nThe code will be something like this.\ntype User struct { Name string } func (u User) changeMe(u User) { u.Name = \"New Name\" } func main(){ u := User{Name: \"mohamed\"} changeMe(u) log.Printf(\"The user is: %s\", u.Name) // mohamed } Note that, we are still printing in mohamed, as we are still passing to the changeMe method a new value. We pass by value in Go. To pass by reference (as in Python or Java), we do this slight change:\ntype User struct { Name string } func (u *User) changeMe(u User) { u.Name = \"New Name\" } func main(){ u := User{Name: \"mohamed\"} changeMe(\u0026u) log.Printf(\"The user is: %s\", u.Name) // New Name } This very small but subtle change was a cause of horror for me in the past couple of days.\nabout marshalling Or really how to do http handlers wrong!\nIn go, everything is initialized to its zero value: \"\" for a string, 0 for int, and nil for pointers. That turns out to be very powerful and it indeeds avoid certain types of bugs. It is also very convenient to use as well. One bad pitfalls of it, but not relevant to my bug is how to differentiate between zero as a value or zero as a initial value. We usually make these types pointers to get a nil instead of its zero value – especially when a zero value is actually meaningful. For example, EBS response code for successfull transactions is 0, and at the same time, when our connection to EBS times out (or any other http connection errors), we get a zero as well (since it is initialized to its zero value). Subtle, but helpful.\nNow, how does that work if we were the server and not the client. That turns out to be very interesting in two distinctive places:\n Go’s encoding/json library and global state (yeah global is really really terrible)  Let us get back to our previous example again and add some json marshalling to it. For breifty our code was like this, i also added an http handler\ntype User struct { ID int // add this field just to make sense  Name string } func (u *User) changeMe(u User) { u.Name = \"New Name\" } func main(){ u := User{Name: \"mohamed\"} changeMe(\u0026u) log.Printf(\"The user is: %s\", u.Name) http.HandlerFunc(\"/create\", createNewUser) http.ListenAndServe(\":8080\", nil) // New Name } // the correct approach func createNewUser(w http.ResponseWriter, r *http.Request){ var u User body, err := ioutil.ReadAll(r.Body) // handle err  defer r.Body.Close() // we have []byte body, let's marshall it  err := json.Marshall(body, \u0026u) // since json.Marshall accepts an interface, we have to send to it the pointer of u not its value  // do DB writeup, etc.. } Now, if we curl:\ncurl -X POST http://localhost:8080/create -d '{\"Name\": \"Mohamed\"}'\nNow, this is cool, simple and straightforward. This code works well. Now let’s fuck it up a bit. I’m gonna make a few changes to instate this brain fuckery.\ntype User struct { ID int // add this field just to make sense  Name string } func (u *User) changeMe(u User) { u.Name = \"New Name\" } var u \u0026User func init(){ u.DB = getMyDbHandler() } func main(){ http.HandlerFunc(\"/create\", u.createNewUser) http.ListenAndServe(\":8080\", nil) // This is bad code... VERY BAD TERRIBLE ONE } // the correct approach func (u *User)createNewUser(w http.ResponseWriter, r *http.Request){ body, err := ioutil.ReadAll(r.Body) // handle err  defer r.Body.Close() // we have []byte body, let's marshall it  err := json.Marshall(body, u) // since json.Marshall accepts an interface, we have to send to it the pointer of u not its value  // do DB writeup, etc.. } What we did is actually simply following one of Go’s http handlers practices. We want to share the DB connection among our services as oppose of creating a new db instead EVERYTIME we connect to a database.\nThis code has two subtilities:\n it manages a global state that is shared between the program (var u \u0026User)  When we json.Marshall in createNewUser, we are not marshalling to a new zero-initialized User struct. Instead we are overriding a previous User struct (e.g., made from a previous request). And this is a stright up memory fuckery.\nThis is literally like this:\n- user1 sends a request and it compelted - when user2 sends a request it overrides user1's *data*  Now, when the really shit gets going:\n and it also subjects to an error in json marshalling  Let’s see\nhow does json marshalling works in Go json.Marshall takes an interface and the reason for that is:\n in go we don’t have generics type json.Marshall uses reflect (or reflection) to get the underlying type of the interface pointer and what we refer to in go as struct tags. They are special syntax attached to the struct to be used by json.Marshall to achieve certain features, one of them being json representation for a struct field, etc.  For example, if we were to return {\"name\": \"Mohamed\"}, instead of {\"Name\": \"Mohamed\"}, we were to do this in User struct definition:\ntype User struct { Name string `json:\"name\"` } and so on.\nNow let’s walk through how json.Marshall actually works in Go:\nAnd bear in mind that every value in go is initalized to its zero value.\nWHAT HAPPENS WHEN WE SEND IN NULL, FROM THE CLIENT!\ncurl -X POST http://localhost:8080/create -d '{\"Name\": null, \"ID\": 1}'\nNow this is interesting!\nWell, that depends. State is bad my friend. Don’t ever manage a state.\n When we first launch the program  $ print(u) {Name: \"\", ID: 1} Now, let’s curl it again, but this time with a value for Name\ncurl -X POST http://localhost:8080/create -d '{\"Name\": \"mohamed\", \"ID\": 1}'\n$ print(u) {Name: \"mohamed\", ID: 1} NOW, let’s curl it again, but this time with null instead. I also changed the ID so one can see where i’m going with this!\ncurl -X POST http://localhost:8080/create -d '{\"Name\": null, \"ID\": 10}'\n$ print(u) {Name: \"mohamed\", ID: 10} WTF! WTF!!!! how this even happened!\nThe reason is two things:\n in our struct tag, we defined Name as a string, not NULL! and the major fuckery is that our code manages state. So, it has the previous data stored there. The previous request data stored there!  In languages like python and javascript, where memory model is so abstracted away it is so hard to fall into this kind of bugs. But in go you do and you do that very simply.\nWhen marshalling a value, in reflection encoding/json iterate through all exported fields to get and match their types with the incoming json. If it fails, it leaves in the specific field as it is with its value and not attempt to change it. That is usefull, totally intuitive and makes sense and a source of a bug for our program.\nThe simple fix is to refactor the struct code to be something like this:\ntype UserService struct { User ... add other fields here } And change the /create handler to be a method receiver for UserService not for User. The reason being we want to preserve state in UserService (for example we want to store DB connection there), AND not storing or keeping track of the User.\n",
  "wordCount" : "1339",
  "inLanguage": "en",
  "datePublished": "2020-10-30T00:00:00Z",
  "dateModified": "2020-10-30T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/2020-10-30-values-types-and-pointers/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "adonese's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="" accesskey="h" title="adonese&#39;s Blog (Alt + H)">adonese&#39;s Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Values and pointers: What could possibly go wrong?
    </h1>
    <div class="post-meta"><span title='2020-10-30 00:00:00 +0000 UTC'>October 30, 2020</span>

</div>
  </header> 
  <div class="post-content"><p>This post highlights a weird and expected behavior we encountered while using Go&rsquo;s <code>encoding/json</code> library.</p>
<p>In go, we pass by value, that really means this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">changeMe</span>(<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>) {
    <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;New Name&#34;</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>(){
    <span style="color:#a6e22e">u</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">User</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;mohamed&#34;</span>}

    <span style="color:#a6e22e">changeMe</span>(<span style="color:#a6e22e">u</span>)
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;The user is: %s&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span>)

    <span style="color:#75715e">// mohamed
</span><span style="color:#75715e"></span>}
</code></pre></div><p>To change by value, we must pass a pointer, we can change the code to be something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">changeMe</span>(<span style="color:#a6e22e">u</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>) {
     <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;New Name&#34;</span>
}

<span style="color:#75715e">// same code
</span><span style="color:#75715e"></span>
    <span style="color:#a6e22e">u</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">User</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;mohamed&#34;</span>}

    <span style="color:#a6e22e">changeMe</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">u</span>)   <span style="color:#75715e">//&lt;--- we made a change here! We should pass the memory address to user
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;The user is: %s&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span>)

    <span style="color:#75715e">// New Name
</span></code></pre></div><p>But in go, we slightly use a different syntax for this, we use a method receiver on the struct. More like method to classes on other languages.</p>
<p>The code will be something like this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>) <span style="color:#a6e22e">changeMe</span>(<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>) {
    <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;New Name&#34;</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>(){
    <span style="color:#a6e22e">u</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">User</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;mohamed&#34;</span>}

    <span style="color:#a6e22e">changeMe</span>(<span style="color:#a6e22e">u</span>)
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;The user is: %s&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span>)

    <span style="color:#75715e">// mohamed
</span><span style="color:#75715e"></span>}
</code></pre></div><p>Note that, we are still printing in <code>mohamed</code>, as we are still passing to the <code>changeMe</code> method a new value. We pass by value in Go. To pass by reference (as in Python or Java), we do this slight change:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">u</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>) <span style="color:#a6e22e">changeMe</span>(<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>) {
    <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;New Name&#34;</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>(){
    <span style="color:#a6e22e">u</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">User</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;mohamed&#34;</span>}

    <span style="color:#a6e22e">changeMe</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">u</span>)
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;The user is: %s&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span>)

    <span style="color:#75715e">// New Name
</span><span style="color:#75715e"></span>}
</code></pre></div><p>This very small but subtle change was a cause of horror for me in the past couple of days.</p>
<h2 id="about-marshalling">about marshalling<a hidden class="anchor" aria-hidden="true" href="#about-marshalling">#</a></h2>
<p>Or really how to do http handlers wrong!</p>
<p>In go, everything is initialized to its zero value: <code>&quot;&quot;</code> for a string, <code>0</code> for int, and <code>nil</code> for pointers. That turns out to be very powerful and it indeeds avoid certain types of bugs. It is also very convenient to use as well. One bad pitfalls of it, but not relevant to my bug is how to differentiate between zero as a value or zero as a initial value. We usually make these types pointers to get a nil instead of its zero value &ndash; especially when a zero value is actually meaningful. For example, EBS response code for successfull transactions is 0, and at the same time, when our connection to EBS times out (or any other http connection errors), we get a zero as well (since it is initialized to its zero value). Subtle, but helpful.</p>
<p>Now, how does that work if we were the server and not the client. That turns out to be very interesting in two distinctive places:</p>
<ul>
<li>Go&rsquo;s <code>encoding/json</code> library</li>
<li>and global state (yeah global is really really terrible)</li>
</ul>
<p>Let us get back to our previous example again and add some json marshalling to it. For breifty our code was like this, i also added an http handler</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">ID</span> <span style="color:#66d9ef">int</span> <span style="color:#75715e">// add this field just to make sense
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">u</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>) <span style="color:#a6e22e">changeMe</span>(<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>) {
    <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;New Name&#34;</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>(){
    <span style="color:#a6e22e">u</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">User</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;mohamed&#34;</span>}

    <span style="color:#a6e22e">changeMe</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">u</span>)
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;The user is: %s&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span>)
    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#e6db74">&#34;/create&#34;</span>, <span style="color:#a6e22e">createNewUser</span>)
    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8080&#34;</span>, <span style="color:#66d9ef">nil</span>)

    <span style="color:#75715e">// New Name
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">// the correct approach
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">createNewUser</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>){
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>
    <span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadAll</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Body</span>)
    <span style="color:#75715e">// handle err
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Body</span>.<span style="color:#a6e22e">Close</span>()

    <span style="color:#75715e">// we have []byte body, let&#39;s marshall it
</span><span style="color:#75715e"></span>
    <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshall</span>(<span style="color:#a6e22e">body</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">u</span>) <span style="color:#75715e">// since json.Marshall accepts an interface, we have to send to it the pointer of u not its value
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// do DB writeup, etc..
</span><span style="color:#75715e"></span>}
</code></pre></div><p>Now, if we curl:</p>
<p><code>curl -X POST http://localhost:8080/create -d '{&quot;Name&quot;: &quot;Mohamed&quot;}'</code></p>
<p>Now, this is cool, simple and straightforward. This code works well. Now let&rsquo;s fuck it up a bit. I&rsquo;m gonna make a few changes to instate this brain fuckery.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">ID</span> <span style="color:#66d9ef">int</span> <span style="color:#75715e">// add this field just to make sense
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">u</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>) <span style="color:#a6e22e">changeMe</span>(<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>) {
    <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;New Name&#34;</span>
}

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">User</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>(){
    <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">DB</span> = <span style="color:#a6e22e">getMyDbHandler</span>()
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>(){
   

    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#e6db74">&#34;/create&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">createNewUser</span>)
    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8080&#34;</span>, <span style="color:#66d9ef">nil</span>)

    <span style="color:#75715e">// This is bad code... VERY BAD TERRIBLE ONE
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">// the correct approach
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">u</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>)<span style="color:#a6e22e">createNewUser</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>){
   
    <span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadAll</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Body</span>)
    <span style="color:#75715e">// handle err
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Body</span>.<span style="color:#a6e22e">Close</span>()

    <span style="color:#75715e">// we have []byte body, let&#39;s marshall it
</span><span style="color:#75715e"></span>
    <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshall</span>(<span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">u</span>) <span style="color:#75715e">// since json.Marshall accepts an interface, we have to send to it the pointer of u not its value
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// do DB writeup, etc..
</span><span style="color:#75715e"></span>}
</code></pre></div><p>What we did is actually simply following one of Go&rsquo;s http handlers practices. We want to share the DB connection among our services as oppose of creating a new db instead EVERYTIME we connect to a database.</p>
<p>This code has two subtilities:</p>
<ul>
<li>it manages a global state that is shared between the program (<code>var u &amp;User</code>)</li>
</ul>
<p>When we <code>json.Marshall</code> in <code>createNewUser</code>, we are not marshalling to a new zero-initialized <code>User</code> struct. Instead we are overriding a previous <code>User</code> struct (e.g., made from a previous request). And this is a stright up memory fuckery.</p>
<p>This is literally like this:</p>
<pre><code>- user1 sends a request and it compelted
- when user2 sends a request it overrides user1's *data*
</code></pre>
<p>Now, when the really shit gets going:</p>
<ul>
<li>and it also subjects to an error in json marshalling</li>
</ul>
<p>Let&rsquo;s see</p>
<h3 id="how-does-json-marshalling-works-in-go">how does json marshalling works in Go<a hidden class="anchor" aria-hidden="true" href="#how-does-json-marshalling-works-in-go">#</a></h3>
<p><code>json.Marshall</code> takes an interface and the reason for that is:</p>
<ul>
<li>in go we don&rsquo;t have generics type</li>
<li>json.Marshall uses reflect (or reflection) to get the underlying type of the interface pointer and what we refer to in go as struct tags. They are special syntax attached to the struct to be used by json.Marshall to achieve certain features, one of them being json representation for a struct field, etc.</li>
</ul>
<p>For example, if we were to return <code>{&quot;name&quot;: &quot;Mohamed&quot;}</code>, instead of <code>{&quot;Name&quot;: &quot;Mohamed&quot;}</code>, we were to do this in User struct definition:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;name&#34;`</span>
}
</code></pre></div><p>and so on.</p>
<p>Now let&rsquo;s walk through how <code>json.Marshall</code> actually works in Go:</p>
<p>And bear in mind that <em>every value in go is initalized to its zero value</em>.</p>
<p>WHAT HAPPENS WHEN WE SEND IN NULL, FROM THE CLIENT!</p>
<p><code>curl -X POST http://localhost:8080/create -d '{&quot;Name&quot;: null, &quot;ID&quot;: 1}'</code></p>
<p>Now this is interesting!</p>
<p>Well, that <em>depends</em>. State is bad my friend. Don&rsquo;t ever manage a state.</p>
<ol>
<li>When we first launch the program</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ print<span style="color:#f92672">(</span>u<span style="color:#f92672">)</span>
<span style="color:#f92672">{</span>Name: <span style="color:#e6db74">&#34;&#34;</span>, ID: 1<span style="color:#f92672">}</span>
</code></pre></div><p>Now, let&rsquo;s curl it again, but this time with a value for Name</p>
<p><code>curl -X POST http://localhost:8080/create -d '{&quot;Name&quot;: &quot;mohamed&quot;, &quot;ID&quot;: 1}'</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ print<span style="color:#f92672">(</span>u<span style="color:#f92672">)</span>
<span style="color:#f92672">{</span>Name: <span style="color:#e6db74">&#34;mohamed&#34;</span>, ID: 1<span style="color:#f92672">}</span>
</code></pre></div><p>NOW, let&rsquo;s curl it <em>again</em>, but this time with null instead. I also changed the ID so one can see where i&rsquo;m going with this!</p>
<p><code>curl -X POST http://localhost:8080/create -d '{&quot;Name&quot;: null, &quot;ID&quot;: 10}'</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ print<span style="color:#f92672">(</span>u<span style="color:#f92672">)</span>
<span style="color:#f92672">{</span>Name: <span style="color:#e6db74">&#34;mohamed&#34;</span>, ID: 10<span style="color:#f92672">}</span>
</code></pre></div><p>WTF! WTF!!!! how this even happened!</p>
<p>The reason is two things:</p>
<ul>
<li>in our struct tag, we defined <code>Name</code> as a string, not NULL!</li>
<li>and the major fuckery is that our code manages state. So, it has the previous data stored there. The previous request data stored there!</li>
</ul>
<p>In languages like python and javascript, where memory model is so abstracted away it is so hard to fall into this kind of bugs. But in go you do and you do that very simply.</p>
<p>When marshalling a value, in reflection <code>encoding/json</code> iterate through all exported fields to get and match their types with the incoming json. If it fails, it <em>leaves in the specific field as it is with its value and not attempt to change it</em>. That is usefull, totally intuitive and makes sense and a source of a bug for our program.</p>
<p>The simple fix is to refactor the struct code to be something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserService</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">User</span>
    <span style="color:#f92672">...</span> <span style="color:#a6e22e">add</span> <span style="color:#a6e22e">other</span> <span style="color:#a6e22e">fields</span> <span style="color:#a6e22e">here</span>
}


</code></pre></div><p>And change the <code>/create</code> handler to be a method receiver for <code>UserService</code> not for <code>User</code>. The reason being we want to preserve state in UserService (for example we want to store DB connection there), <em>AND</em> not storing or keeping track of the <code>User</code>.</p>


  </div>

  <footer class="post-footer">
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="">adonese&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
